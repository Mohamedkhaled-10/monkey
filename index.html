<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚ÙØ±Ø¯ â€” ØºØ±Ù Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (ÙØ§ÙŠØ±Ø¨ÙŠØ²)</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg-1:#07101b;--bg-2:#0b1320;--card:#071827;--muted:#9fb1cf;--accent:#22c55e;--accent-2:#3b82f6;--danger:#ef4444;--glass:rgba(255,255,255,0.03);--radius:14px;--gap:16px;--max:1100px;--txt:#e6edf6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Inter,system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;background:radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.06), transparent),linear-gradient(180deg,var(--bg-1),var(--bg-2) 40%);color:var(--txt);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max);margin:20px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{display:inline-grid;place-items:center;width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),#2563eb);box-shadow:0 6px 20px rgba(37,99,235,0.18);font-size:22px}
    h1{margin:0;font-size:clamp(18px,3.6vw,28px);font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:10px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--glass);padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:13px}
    .chip #meName{font-weight:600}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);border-radius:var(--radius);padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.45)}
    .row{display:flex;gap:10px;align-items:center}
    input,button,select{font-family:inherit}
    .txt{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--txt);outline:none}
    .txt::placeholder{color:rgba(230,237,246,0.4)}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,0.03);color:var(--txt);cursor:pointer;border:1px solid rgba(255,255,255,0.04);transition:transform .12s ease, box-shadow .12s ease}
    .btn.primary{background:linear-gradient(180deg,var(--accent-2),#2563eb);border-color:rgba(37,99,235,0.8);box-shadow:0 6px 18px rgba(37,99,235,0.14)}
    .btn.success{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:rgba(22,163,74,0.85);box-shadow:0 6px 18px rgba(34,197,94,0.12)}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:rgba(249,115,22,0.9)}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:rgba(239,68,68,0.9)}
    .players{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
    @media (max-width:700px){.players{grid-template-columns:repeat(2,1fr)}}
    .p{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);position:relative;min-height:92px}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0f172a,#12203a);display:inline-grid;place-items:center;font-weight:700}
    .turn{position:absolute;inset-inline-start:12px;inset-block-start:12px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,0.03)}
    .turn.active{background:linear-gradient(90deg,#101827,rgba(34,197,94,0.06));box-shadow:0 6px 18px rgba(34,197,94,0.06);border-color:rgba(34,197,94,0.9)}
    .quarters{display:flex;gap:6px;margin-top:8px}
    .q{width:14px;height:14px;border-radius:3px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .q.on{background:linear-gradient(90deg,var(--accent),#16a34a);box-shadow:0 6px 12px rgba(34,197,94,0.12)}
    .word{font-size:36px;letter-spacing:6px;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px dashed rgba(255,255,255,0.03);padding:18px;border-radius:12px;margin:10px 0}
    .tiny{font-size:12px;color:var(--muted)}
    .log{max-height:260px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02)}
    #starterPanel{border-left:4px solid rgba(59,130,246,0.9);padding:12px}
    #challengeArea .confirm{display:flex;gap:8px;align-items:center;justify-content:center}
    .controls-stack{display:flex;gap:8px}
    @media (max-width:540px){.controls-stack{flex-direction:column}}
    .fade-in{animation:fadeIn .28s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)}to{opacity:1; transform:none}}
    input:focus,button:focus{outline:2px solid rgba(99,102,241,0.18);outline-offset:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ğŸ’</div>
        <div>
          <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚ÙØ±Ø¯ â€” ØºØ±Ù Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h1>
          <div class="sub">Ø¥Ù†Ø´Ø¦ ØºØ±ÙØ©ØŒ Ø§Ø¯Ø¹Ù Ù¤ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŒ ÙˆØ§Ù„Ø¹Ø¨ÙˆØ§ Ø¨Ù†ÙØ³ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="chip"><strong id="meName">â€”</strong> Â· <span id="meId" class="tiny">â€”</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="leaveBtn" class="btn">ğŸšª Ù…ØºØ§Ø¯Ø±Ø©</button>
        </div>
      </div>
    </header>

    <section class="grid">
      <div class="card fade-in">
        <h3>Ø§Ù„Ù„ÙˆØ¨Ù‘ÙŠ / Ø§Ù„ØºØ±ÙØ©</h3>
        <div class="row" style="margin-bottom:10px">
          <input id="displayName" class="txt" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¸Ø§Ù‡Ø± (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯)" />
          <button id="saveName" class="btn">ğŸ’¾ Ø­ÙØ¸</button>
        </div>

        <div class="row controls-stack" style="margin-bottom:10px">
          <button id="createRoom" class="btn success">â• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
          <input id="roomCode" class="txt" placeholder="ÙƒÙˆØ¯ ØºØ±ÙØ© (6 Ø£Ø­Ø±Ù)" maxlength="6" style="max-width:220px"/>
          <button id="joinRoom" class="btn primary">ğŸ”— Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>
        <div class="tiny">Ø§Ù„ØºØ±ÙØ© ØªØªØ·Ù„Ø¨ **Ù¤ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·** Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨. Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ…ÙƒÙ†Ù‡ Ø¯Ø¹ÙˆØ© Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.</div>

        <hr style="border-color:rgba(255,255,255,0.03);margin:14px 0">

        <div class="label">Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div class="row" style="align-items:flex-start;gap:18px;margin-top:10px">
          <div style="flex:1">
            <div class="chip">ÙƒÙˆØ¯: <b id="roomCodeView" style="margin-inline-start:6px">â€”</b></div>
            <div class="players" id="players"></div>
          </div>
          <div style="flex:.7;min-width:220px">
            <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
            <div id="roomStatus" class="chip" style="width:100%">â€”</div>
            <div class="label" style="margin-top:10px">Ø§Ù„Ù…Ø¶ÙŠÙ</div>
            <div id="hostName" class="chip" style="width:100%">â€”</div>
          </div>
        </div>
      </div>

      <div class="card fade-in">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨</h3>
        <div class="label">Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…ÙØ¬Ù…Ù‘Ø¹Ø©</div>
        <div class="word" id="prefix">â€”</div>

        <div class="row controls-stack">
          <input id="letterInput" class="txt" maxlength="1" placeholder="Ø§ÙƒØªØ¨ Ø­Ø±ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ (Ù…Ø«Ù„: Ù…)" style="text-align:center;font-size:18px;max-width:140px" />
          <div style="flex:1;display:flex;gap:8px">
            <button id="playLetter" class="btn primary">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±Ù</button>
            <button id="doubtBtn" class="btn warn">â“ Ø£Ø´ÙÙƒ</button>
          </div>
        </div>

        <div id="starterPanel" class="card" style="margin-top:12px;display:none">
          <h4 style="margin:0 0 8px 0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ (ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ ÙÙ‚Ø·)</h4>
          <div class="row">
            <input id="secretInput" class="txt" type="password" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„ÙˆÙ„Ø§ÙŠØ©â€¦" />
            <button id="startRound" class="btn success">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
          </div>
          <div class="tiny" style="margin-top:6px">* Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù† <span class="kbd">Ø£ÙˆÙ„ Ø­Ø±Ù</span> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø«Ù… ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±.</div>
        </div>

        <div id="challengeArea" style="display:none;margin-top:12px" class="card">
          <div class="row" style="align-items:flex-start">
            <div style="flex:2">
              <div class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø³Ø±ÙŠ</div>
              <input id="revealBox" class="txt" type="text" readonly>
              <div class="tiny">Ø§ØªÙ‘ÙÙ‚ÙˆØ§: Ù‡Ù„ Ù‡Ùˆ Ø§Ø³Ù… Ù…ÙƒØ§Ù† Ø­Ù‚ÙŠÙ‚ÙŠØŸ</div>
            </div>
            <div style="flex:1;display:flex;gap:8px;justify-content:center;align-items:center">
              <button id="confirmReal" class="btn success">âœ” Ø­Ù‚ÙŠÙ‚ÙŠ</button>
              <button id="confirmFake" class="btn danger">âœ– ØºÙŠØ± Ø­Ù‚ÙŠÙ‚ÙŠ</button>
            </div>
          </div>
        </div>

        <hr style="border-color:rgba(255,255,255,0.03);margin:16px 0">
        <h3 style="margin-bottom:8px">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
    </section>

    <footer style="margin-top:18px;display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div class="tiny">ÙˆØ§Ø¬Ù‡Ø© Ù…ÙØ­Ø³Ù‘Ù†Ø© â€” Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±.</div>
      <div class="tiny">Ù„ØªØ´ØºÙŠÙ„: ÙØ¹Ù‘Ù„ Anonymous Sign-in ÙÙŠ Firebase ÙˆØ±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù€Database Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±.</div>
    </footer>
  </div>

  <!-- Firebase compat (auth + database) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // --------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ù‡Ù†Ø§) ---------
    const firebaseConfig = {
      apiKey: "AIzaSyDMMu-QNPL6RlGYdGGQVJLzZqCC_hsLa8I",
      authDomain: "night-ac2a0.firebaseapp.com",
      databaseURL: "https://night-ac2a0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "night-ac2a0",
      storageBucket: "night-ac2a0.firebasestorage.app",
      messagingSenderId: "202751732517",
      appId: "1:202751732517:web:5d458d19aac8d7135848cc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --------- Ø¹Ù†Ø§ØµØ± DOM ---------
    const $ = id => document.getElementById(id);
    const meNameEl = $('meName'), meIdEl = $('meId');
    const displayName = $('displayName'), saveName = $('saveName');
    const createRoomBtn = $('createRoom'), joinRoomBtn = $('joinRoom'), roomCodeInput = $('roomCode'), roomCodeView = $('roomCodeView');
    const playersEl = $('players'), roomStatusEl = $('roomStatus'), hostNameEl = $('hostName');
    const prefixEl = $('prefix'), letterInput = $('letterInput'), playLetterBtn = $('playLetter'), doubtBtn = $('doubtBtn');
    const starterPanel = $('starterPanel'), secretInput = $('secretInput'), startRoundBtn = $('startRound');
    const challengeArea = $('challengeArea'), revealBox = $('revealBox'), confirmReal = $('confirmReal'), confirmFake = $('confirmFake');
    const logBox = $('log'), leaveBtn = $('leaveBtn');

    // --------- Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ ---------
    let UID = null;
    let ROOM = null; // ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©
    let roomRef = null;
    let roomUnsub = null;

    // --------- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ---------
    auth.onAuthStateChanged(async user => {
      if(user){
        UID = user.uid;
        meIdEl.textContent = UID.slice(0,8);
        meNameEl.textContent = user.displayName || 'Ù„Ø§Ø¹Ø¨';
        console.log('[Auth] signed in', UID);
      } else {
        try{ await auth.signInAnonymously(); }
        catch(err){
          console.error('[Auth] anonymous sign in failed', err);
          // fallback dev uid
          UID = 'dev-' + Math.random().toString(36).slice(2,10);
          meIdEl.textContent = UID.slice(0,8);
          meNameEl.textContent = 'Ù…Ø·ÙˆØ± (ØªØ¬Ø±ÙŠØ¨ÙŠ)';
        }
      }
    });

    // --------- Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø¸Ù‡ÙˆØ± (ÙÙŠ DB) ---------
    saveName.onclick = async ()=>{
      const name = (displayName.value||'').trim().slice(0,24) || 'Ù„Ø§Ø¹Ø¨';
      meNameEl.textContent = name;
      if(ROOM && UID){
        try{ await db.ref(`rooms/${ROOM}/players/${UID}`).update({ name }); }
        catch(e){ console.warn('[saveName] update failed', e); }
      }
      appendLog('ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶: ' + name);
    };

    // --------- Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ØºØ±ÙØ© ---------
    function codeGen(){
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      let c=''; for(let i=0;i<6;i++) c += chars[Math.floor(Math.random()*chars.length)];
      return c;
    }

    // --------- Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ---------
    async function createRoomFlow(){
      const code = codeGen();
      const now = Date.now();
      const name = displayName.value || 'Ù„Ø§Ø¹Ø¨';
      const data = {
        code,
        createdAt: now,
        host: UID,
        status: 'lobby', // lobby | playing
        order: [],
        turnIndex: 0,
        starterIndex: 0,
        prefix: '',
        secret: '',
        lastActor: null,
        challenge: null
      };
      await db.ref(`rooms/${code}`).set(data);
      await joinRoom(code);
    }

    // --------- Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© ---------
    async function joinRoom(codeRaw){
      try{
        const code = (codeRaw || roomCodeInput.value).toUpperCase();
        if(!code || code.length!==6){ alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØºØ±ÙØ© ØµØ§Ù„Ø­ (Ù¦ Ø£Ø­Ø±Ù).'); return; }
        const snap = await db.ref(`rooms/${code}`).get();
        if(!snap.exists()){ alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.'); return; }
        const room = snap.val();

        const playersSnap = await db.ref(`rooms/${code}/players`).get();
        const players = playersSnap.exists()? playersSnap.val() : {};
        const pCount = Object.keys(players).length;
        if(pCount >= 4 && !players[UID]){ alert('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø© (Ù¤ Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰).'); return; }

        const name = displayName.value || 'Ù„Ø§Ø¹Ø¨';
        await db.ref(`rooms/${code}/players/${UID}`).set({ name, quarters: players[UID]?.quarters ?? 0, joinedAt: Date.now(), online: true });

        // ØªØ±Ø§Ù†Ø²Ø§ÙƒØ´Ù† Ù„Ø¥Ø¶Ø§ÙØ© order
        await db.ref(`rooms/${code}/order`).transaction(order =>{
          order = Array.isArray(order)? order.filter(Boolean): [];
          if(!order.includes(UID)){
            if(order.length >= 4) return order; // Ù…Ù†Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø®Ø§Ù…Ø³
            order.push(UID);
          }
          return order;
        });

        // onDisconnect: Ø§Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙ‚Ø·
        db.ref(`rooms/${code}/players/${UID}`).onDisconnect().remove();

        ROOM = code; roomRef = db.ref(`rooms/${ROOM}`);
        roomCodeView.textContent = ROOM;

        subscribeRoom();
        appendLog('Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ØºØ±ÙØ© ' + ROOM);
      }catch(err){ console.error('[joinRoom]', err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù….'); }
    }

    // --------- Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙŠØ¨Ù†ÙŠ order Ù„Ùˆ ÙØ§Ø¶ÙŠ) ---------
    function renderPlayers(room){
      const pls = room.players || {};
      let order = Array.isArray(room.order)? room.order.slice() : [];

      if((!order || order.length === 0) && Object.keys(pls).length > 0){
        try{
          const entries = Object.entries(pls).map(([id,p])=> ({ id, joinedAt: p.joinedAt || 0 }));
          entries.sort((a,b)=> (a.joinedAt || 0) - (b.joinedAt || 0));
          order = entries.map(e=> e.id);
        }catch(e){ order = Object.keys(pls); }
      }

      playersEl.innerHTML = '';
      for(const id of order){
        const p = pls[id]; if(!p) continue;
        const el = document.createElement('div'); el.className = 'p';
        const roomStatusVal = room.status || 'lobby';
        const isTurn = roomStatusVal === 'playing' && Array.isArray(order) && order[room.turnIndex] === id;
        el.innerHTML = `
          <div class="turn ${isTurn? 'active' : ''}">${isTurn? 'ğŸ¯ Ø¯ÙˆØ±Ù‡ Ø§Ù„Ø¢Ù†' : 'â€”'}</div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="avatar">${(p.name||'Ù„Ø§Ø¹Ø¨').slice(0,1)}</div>
            <div style=\"flex:1\">
              <h3>${p.name||'Ù„Ø§Ø¹Ø¨'} ${id===room.host? 'ğŸ‘‘':''}</h3>
              <div class=\"tiny\">${id.slice(0,8)} Â· ${p.online? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}</div>
            </div>
          </div>
          <div class="quarters">${[0,1,2,3].map(i=>`<span class=\"q ${p.quarters>i?'on':''}\"></span>`).join('')}</div>
        `;
        playersEl.appendChild(el);
      }
      if(playersEl.children.length === 0){ playersEl.innerHTML = '<div class="tiny" style="opacity:.8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø±Ø¦ÙŠÙŠÙ† â€” Ø§ÙØªØ­ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ÙØ­Øµ.</div>'; }
    }

    // --------- Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±ÙØ© ---------
    function subscribeRoom(){
      if(!ROOM) return; if(roomUnsub) roomUnsub();
      const refRoom = db.ref(`rooms/${ROOM}`);
      const listener = refRoom.on('value', snap =>{
        if(!snap.exists()) return;
        const room = snap.val();
        console.log('[room snapshot]', room);
        roomStatusEl.textContent = room.status || 'lobby';
        hostNameEl.textContent = room.players?.[room.host]?.name || 'â€”';
        renderPlayers(room);
        prefixEl.textContent = room.prefix || 'â€”';
        roomCodeView.textContent = ROOM;

        // Ø¹Ø±Ø¶ starterPanel ÙÙ‚Ø· Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const order = Array.isArray(room.order)? room.order : Object.keys(room.players || {});
        const starterIdx = Number.isFinite(room.starterIndex)? room.starterIndex : 0;
        const isStarter = order[starterIdx] === UID;
        starterPanel.style.display = (isStarter && room.status==='playing') ? 'block' : 'none';

        // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠ
        if(room.challenge && room.challenge.active){
          challengeArea.style.display = 'block';
          revealBox.value = room.challenge.revealed || '';
        } else challengeArea.style.display = 'none';
      }, err => console.error('[subscribeRoom] error', err));
      roomUnsub = ()=> refRoom.off('value', listener);
    }

    // --------- Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ù…Ø¶ÙŠÙ) ---------
    async function startGameIfReady(){
      if(!ROOM) return;
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); const count = (r.order||[]).length || Object.keys(r.players||{}).length;
      // ØµØ§Ø± Ù…Ø·Ù„ÙˆØ¨ Ù¤ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·
      if(count !== 4){ alert('Ù„Ø§Ø²Ù… Ù¤ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.'); return; }
      if(r.host !== UID){ alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¨Ø¯Ø¡.'); return; }
      await db.ref(`rooms/${ROOM}`).update({ status:'playing', turnIndex: r.starterIndex || 0, prefix:'', secret:'', lastActor: null, challenge: null });
      appendLog('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø³Ø±ÙŠ ÙˆÙŠØ¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©.');
    }

    // --------- Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ ---------
    async function startRoundFlow(){
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); const order = r.order || Object.keys(r.players||{});
      const starterUid = order[r.starterIndex] || order[0];
      if(starterUid !== UID){ alert('Ù„Ø³Øª Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ Ø§Ù„Ø­Ø§Ù„ÙŠ.'); return; }
      const sec = (secretInput.value||'').trim(); if(!sec || sec.length<2){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ù…Ù† Ø­Ø±ÙÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±.'); return; }
      const first = sec[0];
      const orderLen = order.length || 1;
      await db.ref(`rooms/${ROOM}`).update({ secret: sec, prefix: first, lastActor: starterUid, turnIndex: (r.starterIndex + 1) % orderLen, challenge: null });
      appendLog(`${r.players[starterUid].name} Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ£Ø¹Ù„Ù† Ø£ÙˆÙ„ Ø­Ø±Ù: <b>${first}</b>.`);
      secretInput.value = '';
    }

    // --------- Ø¥Ø±Ø³Ø§Ù„ Ø­Ø±Ù ---------
    async function playLetterFlow(){
      const ch = (letterInput.value||'').trim(); letterInput.value = '';
      if(!ch || ch.length!==1){ alert('Ø£Ø¯Ø®Ù„ Ø­Ø±ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§.'); return; }
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); const order = r.order || Object.keys(r.players||{}); const orderLen = order.length || 1;
      const myTurnUid = order[r.turnIndex]; if(myTurnUid !== UID){ alert('Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†.'); return; }
      const expected = (r.secret || '')[(r.prefix||'').length] || '';
      if(ch !== expected){ await giveQuarterTo(UID, 'Ø­Ø±Ù Ø®Ø§Ø·Ø¦'); return; }
      const newPrefix = (r.prefix||'') + ch; const nextTurnIndex = (r.turnIndex + 1) % orderLen;
      await db.ref(`rooms/${ROOM}`).update({ prefix: newPrefix, lastActor: UID, turnIndex: nextTurnIndex });
      appendLog(`${r.players[UID].name} Ø£Ø¶Ø§Ù Ø§Ù„Ø­Ø±Ù <b>${ch}</b>.`);
      if(newPrefix.length === (r.secret || '').length){
        const penalized = order[nextTurnIndex];
        appendLog(`Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³Ù… (<b>${r.secret}</b>). ${r.players[penalized].name} ÙŠØ£Ø®Ø° Ø±Ø¨Ø¹ Ù‚Ø±Ø¯.`);
        await giveQuarterTo(penalized, 'Ø§Ù„ÙƒÙ„Ù…Ø© Ø§ÙƒØªÙ…Ù„Øª');
      }
    }

    // --------- Ù‚ÙˆÙ„ "Ø£Ø´Ùƒ" ---------
    async function triggerDoubtFlow(){
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); const order = r.order || Object.keys(r.players||{});
      const challenger = order[r.turnIndex]; const previous = r.lastActor;
      if(challenger !== UID){ alert('ÙŠÙ…ÙƒÙ† Ù‚ÙˆÙ„ "Ø£Ø´Ùƒ" ÙÙ‚Ø· ÙÙŠ Ø¯ÙˆØ±Ùƒ.'); return; }
      await db.ref(`rooms/${ROOM}/challenge`).set({ active:true, challenger, previous, revealed: r.secret || '' });
      appendLog(`${r.players[challenger].name} Ù‚Ø§Ù„: <b>Ø£Ø´Ùƒ</b> Ø¹Ù„Ù‰ ${r.players[previous].name}.`);
    }

    // --------- Ø­Ù„ Ø§Ù„ØªØ­Ø¯Ù‘ÙŠ (Ø­Ù‚ÙŠÙ‚ÙŠ/ØºÙŠØ± Ø­Ù‚ÙŠÙ‚ÙŠ) ---------
    async function resolveChallenge(real){
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); if(!r.challenge?.active) return; const target = real ? r.challenge.challenger : r.challenge.previous;
      await giveQuarterTo(target, real? 'ØªØ­Ø¯Ù‘ÙŠ ÙØ§Ø´Ù„ â€” Ø§Ù„Ø§Ø³Ù… Ø­Ù‚ÙŠÙ‚ÙŠ' : 'ØªØ­Ø¯Ù‘ÙŠ Ù†Ø§Ø¬Ø­ â€” Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ø­Ù‚ÙŠÙ‚ÙŠ');
    }

    // --------- Ù…Ù†Ø­ Ø±Ø¨Ø¹ Ù‚Ø±Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ---------
    async function giveQuarterTo(uid, reason){
      await db.ref(`rooms/${ROOM}/players/${uid}/quarters`).transaction(q => (q||0) + 1);
      const snap = await db.ref(`rooms/${ROOM}`).get(); if(!snap.exists()) return;
      const r = snap.val(); const updatedQuarters = r.players?.[uid]?.quarters || 0; const lose = updatedQuarters >= 4;
      appendLog(`<b>${r.players[uid].name}</b> Ø­ØµÙ„ Ø¹Ù„Ù‰ <b>Ø±Ø¨Ø¹ Ù‚Ø±Ø¯</b> (${reason}).`);
      if(lose){ alert(`${r.players[uid].name} Ø¬Ù…Ø¹ Ù‚Ø±Ø¯ ÙƒØ§Ù…Ù„ ğŸ’ â€” Ø®Ø³Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©!`); }
      const order = r.order || Object.keys(r.players||{});
      const newStarter = Math.max(0, order.indexOf(uid));
      await db.ref(`rooms/${ROOM}`).update({ starterIndex: newStarter, turnIndex: newStarter, prefix: '', secret: '', lastActor: null, challenge: null, status: 'lobby' });
    }

    // --------- Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© ---------
    async function leaveRoom(){
      if(!ROOM) return;
      const roomCode = ROOM;
      try{
        await db.ref(`rooms/${roomCode}/players/${UID}`).remove();
        await db.ref(`rooms/${roomCode}/order`).transaction(order => Array.isArray(order)? order.filter(id => id !== UID) : []);
        const rem = await db.ref(`rooms/${roomCode}/players`).get();
        if(!rem.exists()){
          await db.ref(`rooms/${roomCode}`).remove();
        } else {
          const remaining = Object.keys(rem.val()).length;
          if(remaining < 4){
            await db.ref(`rooms/${roomCode}`).update({ status:'lobby', prefix:'', secret:'', lastActor:null, challenge:null });
          }
        }
      }catch(e){ console.warn('[leaveRoom]', e); }
      ROOM = null; roomRef = null; if(roomUnsub) roomUnsub(); roomUnsub = null;
      roomCodeView.textContent = 'â€”'; playersEl.innerHTML = ''; roomStatusEl.textContent = 'â€”'; hostNameEl.textContent = 'â€”'; prefixEl.textContent = 'â€”'; challengeArea.style.display='none';
      appendLog('ØºØ§Ø¯Ø±Øª Ø§Ù„ØºØ±ÙØ©.');
    }

    // --------- Ø³Ø¬Ù„Ù‘ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù…Ø­Ù„ÙŠ + Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙÙŠ DB) ---------
    function appendLog(html){
      const time = new Date().toLocaleTimeString('ar-EG',{hour12:false});
      logBox.innerHTML = `<div class="tiny" style="color:#9fb1cf">[${time}]</div><div>${html}</div>` + logBox.innerHTML;
      if(ROOM) db.ref(`rooms/${ROOM}/log`).push({ t: Date.now(), html });
    }

    // --------- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---------
    createRoomBtn.onclick = createRoomFlow;
    joinRoomBtn.onclick = ()=> joinRoom();
    leaveBtn.onclick = leaveRoom;
    roomStatusEl.onclick = startGameIfReady;
    startRoundBtn.onclick = startRoundFlow;
    playLetterBtn.onclick = playLetterFlow;
    letterInput.addEventListener('keydown', e=>{ if(e.key === 'Enter') playLetterFlow(); });
    doubtBtn.onclick = triggerDoubtFlow;
    confirmReal.onclick = ()=> resolveChallenge(true);
    confirmFake.onclick = ()=> resolveChallenge(false);

    // Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± room ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
    const params = new URLSearchParams(location.search); const preset = params.get('room'); if(preset) roomCodeInput.value = preset.toUpperCase();

    // Ù†ØµØ§Ø¦Ø­ Ø£Ù…Ø§Ù† (Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§ Ù„Ù„Ù…Ø·ÙˆØ±):
    // - ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø¶Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Realtime Database ØªÙ…Ù†Ø¹ Ù‚Ø±Ø§Ø¡Ø© rooms/$room/secret Ø¥Ù„Ø§ Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ (UID Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚).
    // - Ø£Ùˆ Ù„Ø§ ØªØ®Ø²Ù† Ø§Ù„Ø³Ø± ÙÙŠ DB Ø¥Ø·Ù„Ø§Ù‚Ù‹Ø§ØŒ ÙˆØ¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ Ø§Ø³ØªØ®Ø¯Ù… Cloud Function Ù„ÙØ­Øµ Ø§Ù„Ø­Ø±ÙˆÙ.
    // - Ø§Ù„Ø¢Ù† Ø§Ù„Ù†Ø³Ø®Ø© ØªØ¹Ù…Ù„ ÙƒÙ€ prototype: Ø§Ù„Ø³Ø± Ù…Ø®Ø²Ù‘Ù† ÙÙŠ DB ÙˆÙŠÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯Ù‘ÙŠ Ø£Ùˆ Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ (UI). Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø·Ù„ÙˆØ¨ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±.

    appendLog('Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø². Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø£Ùˆ Ø§Ù†Ø¶Ù… Ù„Ø£Ø®Ø±Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨.');
  </script>
</body>
</html>
